<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­æ–‡æ‰“å­—ç»ƒä¹ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            user-select: none;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        .title {
            text-align: center;
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .practice-area {
            margin-bottom: 30px;
        }

        .display-area {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 15px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* å®Œæˆæç¤º */
        .complete-hint {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 14px;
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            animation: fadeIn 0.3s;
        }

        /* æ‹¼éŸ³éŸ³è°ƒæ˜¾ç¤º */
        .pinyin-with-tone {
            font-size: 20px;
            color: #999;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .pinyin-line {
            font-size: 32px;
            color: #666;
            letter-spacing: 3px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .pinyin-char {
            padding: 2px 4px;
            margin: 0 1px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
        }

        .pinyin-char.completed {
            background: #4CAF50;
            color: white;
            transform: scale(1.1);
        }

        .pinyin-char.error {
            background: #f44336;
            color: white;
            animation: shake 0.5s;
        }

        .pinyin-char.current {
            background: #2196F3;
            color: white;
            animation: blink 1s infinite;
        }

        .pinyin-char.skipped {
            background: #ff9800;
            color: white;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.6; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chinese-line {
            font-size: 48px;
            color: #333;
            font-weight: bold;
            letter-spacing: 10px;
        }

        /* å¥å­ç»ƒä¹ æ ·å¼ */
        .sentence-display {
            font-size: 28px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 20px;
            text-align: left;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .sentence-char {
            transition: all 0.2s;
            display: inline;
        }

        .sentence-char.completed {
            color: #4CAF50;
            font-weight: bold;
        }

        .sentence-char.error {
            color: #f44336;
            background: #ffebee;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .sentence-char.current {
            background: #e3f2fd;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .sentence-input {
            width: 100%;
            padding: 15px;
            font-size: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .sentence-input:focus {
            border-color: #4CAF50;
        }

        /* èµ„æºé€‰æ‹©å™¨ */
        .resource-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .resource-selector select {
            padding: 10px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            margin: 0 10px;
        }

        .resource-selector button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            background: #ff9800;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 5px;
        }

        .resource-selector button:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .loading {
            display: inline-block;
            margin-left: 10px;
            color: #666;
        }

        .keyboard-wrapper {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .keyboard {
            max-width: 700px;
            margin: 0 auto;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }

        .keyboard-row:nth-child(2) {
            padding-left: 20px;
        }

        .keyboard-row:nth-child(3) {
            padding-left: 40px;
        }

        .key {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px 12px;
            min-width: 45px;
            height: 45px;
            text-align: center;
            font-size: 16px;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.1s;
            font-weight: 500;
            margin: 0 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .key.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .key.error-key {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .key.next-key {
            animation: keyBlink 1s infinite;
            border-color: #2196F3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
        }

        @keyframes keyBlink {
            0%, 50% { 
                background: #e3f2fd;
                transform: scale(1.05);
            }
            51%, 100% { 
                background: white;
                transform: scale(1);
            }
        }

        .key.space {
            min-width: 300px;
        }

        .key.enter {
            min-width: 90px;
            background: #e3f2fd;
        }

        .key.enter.highlight {
            animation: enterHighlight 1s infinite;
        }

        @keyframes enterHighlight {
            0%, 50% { background: #e3f2fd; }
            51%, 100% { background: #bbdefb; }
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            flex: 1;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            color: #333;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .controls {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 10px;
            font-weight: 500;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        .message {
            text-align: center;
            font-size: 18px;
            color: #666;
            margin: 20px 0;
            min-height: 30px;
        }

        .message.success {
            color: #4CAF50;
        }

        .message.error {
            color: #f44336;
        }

        .message.info {
            color: #2196F3;
        }

        .message.warning {
            color: #ff9800;
        }

        .phase-indicator {
            text-align: center;
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .phase-indicator.active {
            color: #4CAF50;
            font-size: 18px;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s;
        }

        .modal-content h2 {
            font-size: 32px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .final-stats {
            margin: 30px 0;
            text-align: left;
        }

        .final-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .final-stat-label {
            color: #666;
        }

        .final-stat-value {
            font-weight: bold;
            color: #333;
        }

        .grade {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }

        .grade.S { color: #ff9800; }
        .grade.A { color: #4CAF50; }
        .grade.B { color: #2196F3; }
        .grade.C { color: #9c27b0; }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .btn-close {
            background: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-close:hover {
            background: #45a049;
        }

        .hidden {
            display: none !important;
        }

        input[type="file"] {
            display: none;
        }

        .current-category {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .file-info {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.19.6/dist/index.js"></script>
</head>
<body>
    <div class="container">
        <h1 class="title">ä¸­æ–‡æ‰“å­—ç»ƒä¹ </h1>
        
        <!-- èµ„æºé€‰æ‹©å™¨ -->
        <div class="resource-selector">
            <select id="resourceType" onchange="autoLoadResources()">
                <option value="default">é»˜è®¤è¯åº“</option>
            </select>
            <button class="btn-file" onclick="document.getElementById('fileInput').click()">åŠ è½½æ–‡ä»¶</button>
            <input type="file" id="fileInput" accept=".json,.txt" onchange="loadFile(event)">
            <span class="loading hidden" id="loadingIndicator">åŠ è½½ä¸­...</span>
            <div class="current-category" id="currentCategory"></div>
            <div class="file-info" id="fileInfo"></div>
        </div>
        
        <div class="practice-area">
            <div class="phase-indicator" id="phaseIndicator">ç¬¬ä¸€é˜¶æ®µï¼šæ‹¼éŸ³ç»ƒä¹ </div>
            
            <div class="display-area">
                <div id="pinyinPractice">
                    <div class="pinyin-with-tone" id="pinyinWithTone">yÃ¡n xiÃ </div>
                    <div class="pinyin-line" id="pinyinLine"></div>
                    <div class="chinese-line" id="chineseLine">ç‚å¤</div>
                    <div class="complete-hint">æŒ‰ Enter é”®æäº¤</div>
                </div>
                
                <div id="sentencePractice" class="hidden">
                    <div class="sentence-display" id="sentenceDisplay"></div>
                    <input type="text" class="sentence-input" id="sentenceInput" placeholder="è¯·è¾“å…¥ä¸Šé¢çš„å¥å­..." autocomplete="off">
                    <div class="complete-hint">æŒ‰ Enter é”®æäº¤</div>
                </div>
            </div>

            <div class="message" id="message">ç‚¹å‡»"å¼€å§‹ç»ƒä¹ "ï¼Œéšæ—¶æŒ‰ Enter é”®æäº¤</div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>

            <div class="keyboard-wrapper" id="keyboardWrapper">
                <div class="keyboard">
                    <div class="keyboard-row">
                        <div class="key" data-key="`">~<br>`</div>
                        <div class="key" data-key="1">!<br>1</div>
                        <div class="key" data-key="2">@<br>2</div>
                        <div class="key" data-key="3">#<br>3</div>
                        <div class="key" data-key="4">$<br>4</div>
                        <div class="key" data-key="5">%<br>5</div>
                        <div class="key" data-key="6">^<br>6</div>
                        <div class="key" data-key="7">&<br>7</div>
                        <div class="key" data-key="8">*<br>8</div>
                        <div class="key" data-key="9">(<br>9</div>
                        <div class="key" data-key="0">)<br>0</div>
                        <div class="key" data-key="-">_<br>-</div>
                        <div class="key" data-key="=">+<br>=</div>
                        <div class="key" data-key="backspace">â†</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key" data-key="tab">Tab</div>
                        <div class="key" data-key="q">Q</div>
                        <div class="key" data-key="w">W</div>
                        <div class="key" data-key="e">E</div>
                        <div class="key" data-key="r">R</div>
                        <div class="key" data-key="t">T</div>
                        <div class="key" data-key="y">Y</div>
                        <div class="key" data-key="u">U</div>
                        <div class="key" data-key="i">I</div>
                        <div class="key" data-key="o">O</div>
                        <div class="key" data-key="p">P</div>
                        <div class="key" data-key="[">{<br>[</div>
                        <div class="key" data-key="]">}<br>]</div>
                        <div class="key" data-key="\">|<br>\</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key" data-key="capslock">Caps</div>
                        <div class="key" data-key="a">A</div>
                        <div class="key" data-key="s">S</div>
                        <div class="key" data-key="d">D</div>
                        <div class="key" data-key="f">F</div>
                        <div class="key" data-key="g">G</div>
                        <div class="key" data-key="h">H</div>
                        <div class="key" data-key="j">J</div>
                        <div class="key" data-key="k">K</div>
                        <div class="key" data-key="l">L</div>
                        <div class="key" data-key=";">:<br>;</div>
                        <div class="key" data-key="'">"<br>'</div>
                        <div class="key enter" data-key="enter">Enter</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key" data-key="shift">Shift</div>
                        <div class="key" data-key="z">Z</div>
                        <div class="key" data-key="x">X</div>
                        <div class="key" data-key="c">C</div>
                        <div class="key" data-key="v">V</div>
                        <div class="key" data-key="b">B</div>
                        <div class="key" data-key="n">N</div>
                        <div class="key" data-key="m">M</div>
                        <div class="key" data-key=",">&lt;<br>,</div>
                        <div class="key" data-key=".">&gt;<br>.</div>
                        <div class="key" data-key="/">?<br>/</div>
                        <div class="key" data-key="shift">Shift</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key space" data-key=" ">Space</div>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">é€Ÿåº¦/åˆ†é’Ÿ</div>
                    <div class="stat-value" id="speedStat">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å‡†ç¡®ç‡</div>
                    <div class="stat-value" id="accuracyStat">100%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å®Œæˆè¿›åº¦</div>
                    <div class="stat-value" id="progressStat">0/10</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="startBtn" onclick="startPractice()">å¼€å§‹ç»ƒä¹ </button>
            <button class="btn btn-secondary" onclick="resetPractice()">é‡ç½®</button>
        </div>
    </div>

    <!-- å®Œæˆå¼¹çª— -->
    <div class="modal" id="completeModal">
        <div class="modal-content">
            <h2>ğŸ‰ æ­å–œå®Œæˆï¼</h2>
            <div class="grade" id="grade">A</div>
            <div class="final-stats">
                <div class="final-stat-item">
                    <span class="final-stat-label">æ€»ç”¨æ—¶</span>
                    <span class="final-stat-value" id="finalTime">0ç§’</span>
                </div>
                <div class="final-stat-item">
                    <span class="final-stat-label">å¹³å‡é€Ÿåº¦</span>
                    <span class="final-stat-value" id="finalSpeed">0 å­—/åˆ†é’Ÿ</span>
                </div>
                <div class="final-stat-item">
                    <span class="final-stat-label">å‡†ç¡®ç‡</span>
                    <span class="final-stat-value" id="finalAccuracy">100%</span>
                </div>
                <div class="final-stat-item">
                    <span class="final-stat-label">é”™è¯¯æ¬¡æ•°</span>
                    <span class="final-stat-value" id="finalErrors">0</span>
                </div>
                <div class="final-stat-item">
                    <span class="final-stat-label">æœªå®Œæˆæäº¤</span>
                    <span class="final-stat-value" id="finalSkipped">0</span>
                </div>
            </div>
            <button class="btn-close" onclick="closeModal()">å…³é—­</button>
        </div>
    </div>

    <script>
        // ä¸­æ–‡èµ„æºæ•°æ®
        let chineseResources = null;
        
        // é»˜è®¤ç»ƒä¹ è¯åº“
        let practiceWords = [];
        let practiceSentences = [];
        let currentCategoryName = 'é»˜è®¤è¯åº“';

        // çŠ¶æ€å˜é‡
        let currentPhase = 'pinyin';
        let currentWordIndex = 0;
        let currentSentenceIndex = 0;
        let currentCharIndex = 0;
        let startTime = null;
        let phaseStartTime = null;
        let correctChars = 0;
        let totalChars = 0;
        let errorCount = 0;
        let isActive = false;
        let completedItems = 0;
        let skippedCount = 0;
        let currentNextKey = null;

        // DOMå…ƒç´ 
        const pinyinLine = document.getElementById('pinyinLine');
        const pinyinWithTone = document.getElementById('pinyinWithTone');
        const chineseLine = document.getElementById('chineseLine');
        const message = document.getElementById('message');
        const progressBar = document.getElementById('progressBar');
        const speedStat = document.getElementById('speedStat');
        const accuracyStat = document.getElementById('accuracyStat');
        const progressStat = document.getElementById('progressStat');
        const startBtn = document.getElementById('startBtn');
        const phaseIndicator = document.getElementById('phaseIndicator');
        const pinyinPractice = document.getElementById('pinyinPractice');
        const sentencePractice = document.getElementById('sentencePractice');
        const sentenceDisplay = document.getElementById('sentenceDisplay');
        const sentenceInput = document.getElementById('sentenceInput');
        const keyboardWrapper = document.getElementById('keyboardWrapper');
        const completeModal = document.getElementById('completeModal');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const currentCategory = document.getElementById('currentCategory');
        const fileInfo = document.getElementById('fileInfo');

        // åˆå§‹åŒ–é»˜è®¤åˆ†ç±»
        function initDefaultCategories() {
            const select = document.getElementById('resourceType');
            select.innerHTML = '<option value="default">é»˜è®¤è¯åº“</option>';
        }

        // æ·»åŠ åˆ†ç±»é€‰é¡¹
        function addCategoryOption(value, text) {
            const select = document.getElementById('resourceType');
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = Array.from(select.options).some(option => option.value === value);
            if (!exists) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                select.appendChild(option);
            }
        }

        // åŠ è½½èµ„æºæ–‡ä»¶ï¼ˆåˆå§‹åŒ–ï¼‰
        async function loadResourceFile() {
            // åˆå§‹åŒ–é»˜è®¤é€‰é¡¹
            initDefaultCategories();
            // ä½¿ç”¨é»˜è®¤æ•°æ®
            setDefaultData();
        }

        // è®¾ç½®é»˜è®¤æ•°æ®
        function setDefaultData() {
            practiceWords = [
                { chinese: 'ç‚å¤', pinyin: 'yanxia', pinyinTone: 'yÃ¡n xiÃ ' },
                { chinese: 'æ˜¥å¤©', pinyin: 'chuntian', pinyinTone: 'chÅ«n tiÄn' },
                { chinese: 'å­¦ä¹ ', pinyin: 'xuexi', pinyinTone: 'xuÃ© xÃ­' },
                { chinese: 'ç”µè„‘', pinyin: 'diannao', pinyinTone: 'diÃ n nÇo' },
                { chinese: 'æœ‹å‹', pinyin: 'pengyou', pinyinTone: 'pÃ©ng yÇ’u' }
            ];
            practiceSentences = [
                'æ˜¥å¤©çš„èŠ±æœµéå¸¸ç¾ä¸½ã€‚',
                'æˆ‘å–œæ¬¢å’Œæœ‹å‹ä¸€èµ·å­¦ä¹ ã€‚',
                'ç”µè„‘æ˜¯ç°ä»£ç”Ÿæ´»çš„å·¥å…·ã€‚'
            ];
            currentCategoryName = 'é»˜è®¤è¯åº“';
            updateCategoryDisplay();
        }

        // åŠ è½½æŒ‡å®šç±»åˆ«çš„æ•°æ®
        function loadCategoryData(category) {
            if (!chineseResources || !chineseResources.categories[category]) {
                return;
            }

            const categoryData = chineseResources.categories[category];
            currentCategoryName = categoryData.name;
            
            // å¤„ç†è¯æ±‡ï¼Œç”Ÿæˆæ‹¼éŸ³
            practiceWords = categoryData.words.slice(0, 10).map(word => {
                const pinyinTone = pinyinPro.pinyin(word, { toneType: 'symbol', type: 'array' }).join(' ');
                const pinyinNoTone = pinyinPro.pinyin(word, { toneType: 'none', type: 'array' }).join('');
                
                return {
                    chinese: word,
                    pinyin: pinyinNoTone.toLowerCase(),
                    pinyinTone: pinyinTone
                };
            });

            // ä½¿ç”¨å¥å­
            practiceSentences = categoryData.sentences.slice(0, 5);
            updateCategoryDisplay();
        }

        // æ›´æ–°åˆ†ç±»æ˜¾ç¤º
        function updateCategoryDisplay() {
            currentCategory.textContent = `å½“å‰åˆ†ç±»ï¼š${currentCategoryName}`;
            fileInfo.textContent = '';
        }

        // è‡ªåŠ¨åŠ è½½èµ„æº
        function autoLoadResources() {
            const resourceType = document.getElementById('resourceType').value;
            
            if (resourceType === 'default') {
                setDefaultData();
                resetPractice();
                message.textContent = 'å·²åŠ è½½é»˜è®¤è¯åº“';
                message.className = 'message success';
            } else if (chineseResources && chineseResources.categories[resourceType]) {
                loadCategoryData(resourceType);
                resetPractice();
                message.textContent = `å·²åŠ è½½${currentCategoryName}`;
                message.className = 'message success';
            }
        }

        // åŠ è½½æ–‡ä»¶ - è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            const fileName = file.name.toLowerCase();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (fileName.endsWith('.json')) {
                        // å¤„ç†JSONæ–‡ä»¶
                        handleJsonFile(content, file.name);
                    } else if (fileName.endsWith('.txt')) {
                        // å¤„ç†TXTæ–‡ä»¶
                        handleTxtFile(content, file.name);
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                    }
                    
                    resetPractice();
                    message.textContent = 'æ–‡ä»¶åŠ è½½æˆåŠŸï¼';
                    message.className = 'message success';
                } catch (error) {
                    console.error('æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
                    message.textContent = 'æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message;
                    message.className = 'message error';
                }
            };
            
            reader.readAsText(file);
        }

        // å¤„ç†JSONæ–‡ä»¶
        function handleJsonFile(content, fileName) {
            const data = JSON.parse(content);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºå®Œæ•´çš„èµ„æºæ–‡ä»¶æ ¼å¼
            if (data.categories) {
                // å®Œæ•´çš„èµ„æºæ–‡ä»¶
                if (!chineseResources) chineseResources = { categories: {} };
                
                // æ·»åŠ åˆ°é€‰æ‹©æ 
                Object.entries(data.categories).forEach(([key, value]) => {
                    addCategoryOption(key, value.name);
                });
                
                // ä¿å­˜èµ„æºæ•°æ®
                Object.assign(chineseResources.categories, data.categories);
                
                // é€‰æ‹©ç¬¬ä¸€ä¸ªç±»åˆ«
                const firstCategory = Object.keys(data.categories)[0];
                if (firstCategory) {
                    loadCategoryData(firstCategory);
                    document.getElementById('resourceType').value = firstCategory;
                }
                
                fileInfo.textContent = `å·²åŠ è½½: ${fileName} (${Object.keys(data.categories).length}ä¸ªåˆ†ç±»)`;
            } else if (data.words && data.sentences) {
                // ç®€å•æ ¼å¼çš„JSONæ–‡ä»¶
                const categoryKey = fileName.replace('.json', '').replace(/\s+/g, '_');
                const categoryName = fileName.replace('.json', '');
                
                // æ·»åŠ åˆ°é€‰æ‹©æ 
                addCategoryOption(categoryKey, categoryName);
                
                // ä¿å­˜æ•°æ®
                if (!chineseResources) chineseResources = { categories: {} };
                chineseResources.categories[categoryKey] = {
                    name: categoryName,
                    words: data.words,
                    sentences: data.sentences
                };
                
                // é€‰æ‹©è¿™ä¸ªåˆ†ç±»
                document.getElementById('resourceType').value = categoryKey;
                loadCategoryData(categoryKey);
                
                fileInfo.textContent = `å·²åŠ è½½: ${fileName} (${data.words.length}ä¸ªè¯, ${data.sentences.length}ä¸ªå¥å­)`;
            } else {
                throw new Error('JSONæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            }
        }

        // å¤„ç†TXTæ–‡ä»¶
        function handleTxtFile(content, fileName) {
            // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºåˆ†ç±»å
            const categoryKey = fileName.replace('.txt', '').replace(/\s+/g, '_');
            const categoryName = fileName.replace('.txt', '');
            
            const lines = content.split(/[\n\r]+/).filter(line => line.trim());
            const words = [];
            const sentences = [];
            
            // ä¸­æ–‡å¥å­ç»“æŸç¬¦å·
            const sentenceEndings = ['ã€‚', 'ï¼', 'ï¼Ÿ', 'ï¼›', 'â€¦'];
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¥å­
                const isSentence = sentenceEndings.some(ending => line.includes(ending)) || 
                                 line.length > 15 || // é•¿åº¦è¶…è¿‡15ä¸ªå­—ç¬¦å¯èƒ½æ˜¯å¥å­
                                 /[ï¼Œã€]/.test(line); // åŒ…å«é€—å·æˆ–é¡¿å·å¯èƒ½æ˜¯å¥å­
                
                if (isSentence) {
                    // å¦‚æœæ²¡æœ‰å¥å·ï¼Œè‡ªåŠ¨æ·»åŠ 
                    if (!sentenceEndings.some(ending => line.endsWith(ending))) {
                        line += 'ã€‚';
                    }
                    sentences.push(line);
                } else if (line.length <= 10) {
                    // çŸ­æ–‡æœ¬ä½œä¸ºè¯æ±‡
                    words.push(line);
                }
            });
            
            // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°è¯æ±‡ï¼Œå°†çŸ­å¥å­ä¹Ÿä½œä¸ºè¯æ±‡
            if (words.length === 0 && sentences.length > 0) {
                sentences.forEach(sentence => {
                    // æŒ‰æ ‡ç‚¹ç¬¦å·åˆ†å‰²å¥å­
                    const parts = sentence.split(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ã€]+/).filter(part => part.trim());
                    parts.forEach(part => {
                        if (part.length <= 8 && part.length > 0) {
                            words.push(part);
                        }
                    });
                });
            }
            
            // æ·»åŠ åˆ°é€‰æ‹©æ 
            addCategoryOption(categoryKey, categoryName);
            
            // ä¿å­˜åˆ°èµ„æºä¸­
            if (!chineseResources) chineseResources = { categories: {} };
            chineseResources.categories[categoryKey] = {
                name: categoryName,
                words: words,
                sentences: sentences
            };
            
            // é€‰æ‹©è¿™ä¸ªåˆ†ç±»
            document.getElementById('resourceType').value = categoryKey;
            
            // ç”Ÿæˆæ‹¼éŸ³å¹¶åŠ è½½
            currentCategoryName = categoryName;
            practiceWords = words.slice(0, 20).map(word => {
                const pinyinTone = pinyinPro.pinyin(word, { toneType: 'symbol', type: 'array' }).join(' ');
                const pinyinNoTone = pinyinPro.pinyin(word, { toneType: 'none', type: 'array' }).join('');
                
                return {
                    chinese: word,
                    pinyin: pinyinNoTone.toLowerCase(),
                    pinyinTone: pinyinTone
                };
            });
            
            practiceSentences = sentences.slice(0, 10);
            updateCategoryDisplay();
            fileInfo.textContent = `å·²åŠ è½½: ${fileName} (${practiceWords.length}ä¸ªè¯, ${practiceSentences.length}ä¸ªå¥å­)`;
        }

        // æ›´æ–°ä¸‹ä¸€ä¸ªæŒ‰é”®æç¤º
        function updateNextKeyHint() {
            // æ¸…é™¤ä¹‹å‰çš„æç¤º
            if (currentNextKey) {
                const prevKey = document.querySelector(`[data-key="${currentNextKey}"]`);
                if (prevKey) {
                    prevKey.classList.remove('next-key');
                }
            }

            if (currentPhase === 'pinyin' && isActive) {
                const currentWord = practiceWords[currentWordIndex];
                if (currentCharIndex < currentWord.pinyin.length) {
                    const nextChar = currentWord.pinyin[currentCharIndex];
                    const keyElement = document.querySelector(`[data-key="${nextChar}"]`);
                    if (keyElement) {
                        keyElement.classList.add('next-key');
                        currentNextKey = nextChar;
                    }
                }
            }
        }

        // åˆå§‹åŒ–æ‹¼éŸ³æ˜¾ç¤º
        function initPinyinDisplay() {
            const currentWord = practiceWords[currentWordIndex];
            chineseLine.textContent = currentWord.chinese;
            pinyinWithTone.textContent = currentWord.pinyinTone;
            
            pinyinLine.innerHTML = '';
            currentWord.pinyin.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.className = 'pinyin-char';
                span.textContent = char;
                if (index === 0) span.classList.add('current');
                pinyinLine.appendChild(span);
            });
            
            updateNextKeyHint();
        }

        // åˆå§‹åŒ–å¥å­æ˜¾ç¤º
        function initSentenceDisplay() {
            const currentSentence = practiceSentences[currentSentenceIndex];
            sentenceDisplay.innerHTML = '';
            
            currentSentence.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.className = 'sentence-char';
                span.textContent = char;
                if (index === 0) span.classList.add('current');
                sentenceDisplay.appendChild(span);
            });
            
            sentenceInput.value = '';
            sentenceInput.focus();
        }

        // é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆæ‹¼éŸ³ç»ƒä¹ ï¼‰
        document.addEventListener('keydown', (e) => {
            if (!isActive || currentPhase !== 'pinyin') return;

            const key = e.key.toLowerCase();
            
            // å¤„ç†Enteré”® - éšæ—¶å¯ä»¥æäº¤
            if (key === 'enter') {
                e.preventDefault();
                submitCurrentWord();
                return;
            }
            
            if (key === 'backspace' || key === 'escape') {
                e.preventDefault();
                return;
            }

            if (!/^[a-z]$/.test(key)) return;

            e.preventDefault();

            // æ˜¾ç¤ºæŒ‰é”®åé¦ˆ
            const keyElement = document.querySelector(`[data-key="${key}"]`);
            if (keyElement) {
                keyElement.classList.add('active');
                setTimeout(() => keyElement.classList.remove('active'), 100);
            }

            handlePinyinInput(key);
        });

        // æäº¤å½“å‰è¯ç»„
        function submitCurrentWord() {
            const currentWord = practiceWords[currentWordIndex];
            const pinyinChars = pinyinLine.children;
            
            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            const isComplete = currentCharIndex >= currentWord.pinyin.length;
            
            if (!isComplete) {
                // æœªå®Œæˆæäº¤
                skippedCount++;
                
                // å°†æœªè¾“å…¥çš„å­—ç¬¦ç»Ÿè®¡åˆ°æ€»å­—ç¬¦æ•°ä¸­ï¼Œä½†ä¸è®¡å…¥æ­£ç¡®å­—ç¬¦
                for (let i = currentCharIndex; i < currentWord.pinyin.length; i++) {
                    pinyinChars[i].classList.add('skipped');
                    totalChars++; // å¢åŠ æ€»å­—ç¬¦æ•°
                    // ä¸å¢åŠ  correctCharsï¼Œè¿™æ ·ä¼šé™ä½å‡†ç¡®ç‡
                }
                
                message.textContent = 'æœªå®Œæˆæäº¤ï¼ç»§ç»­ä¸‹ä¸€ä¸ª...';
                message.className = 'message warning';
            } else {
                message.textContent = 'å®Œæˆï¼ç»§ç»­ä¸‹ä¸€ä¸ª...';
                message.className = 'message success';
            }
            
            completedItems++;
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            // ç­‰å¾…ä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°ç»“æœ
            setTimeout(() => {
                nextPinyinWord();
            }, 500);
        }

        // å¤„ç†æ‹¼éŸ³è¾“å…¥
        function handlePinyinInput(key) {
            const currentWord = practiceWords[currentWordIndex];
            const targetChar = currentWord.pinyin[currentCharIndex];
            const pinyinChars = pinyinLine.children;
        
            totalChars++;
        
            if (key === targetChar) {
                correctChars++;
                pinyinChars[currentCharIndex].classList.remove('current', 'error');
                pinyinChars[currentCharIndex].classList.add('completed');
                
                currentCharIndex++;
        
                if (currentCharIndex < currentWord.pinyin.length) {
                    pinyinChars[currentCharIndex].classList.add('current');
                    updateNextKeyHint();
                } else {
                    // è¯ç»„è¾“å…¥å®Œæˆ
                    document.querySelector('[data-key="enter"]').classList.add('highlight');
                    message.textContent = 'è¾“å…¥å®Œæˆï¼æŒ‰ Enter é”®ç»§ç»­';
                    message.className = 'message info';
                    updateNextKeyHint();
                }
            } else {
                // é”™è¯¯è¾“å…¥ä¸å¢åŠ  correctChars
                // totalChars å·²ç»å¢åŠ äº†ï¼Œæ‰€ä»¥å‡†ç¡®ç‡ä¼šè‡ªåŠ¨é™ä½
                pinyinChars[currentCharIndex].classList.add('error');
                
                const keyElement = document.querySelector(`[data-key="${key}"]`);
                if (keyElement) {
                    keyElement.classList.add('error-key');
                    setTimeout(() => keyElement.classList.remove('error-key'), 300);
                }
        
                setTimeout(() => {
                    pinyinChars[currentCharIndex].classList.remove('error');
                }, 500);
            }
        
            updateStats();
        }

        // å¥å­è¾“å…¥å¤„ç†
        sentenceInput.addEventListener('input', (e) => {
            if (!isActive || currentPhase !== 'sentence') return;
        
            const input = e.target.value;
            const targetSentence = practiceSentences[currentSentenceIndex];
            const sentenceChars = sentenceDisplay.children;
        
            // æ¸…é™¤æ‰€æœ‰çŠ¶æ€
            Array.from(sentenceChars).forEach(char => {
                char.classList.remove('completed', 'error', 'current');
            });
        
            // é€å­—ç¬¦éªŒè¯ï¼ˆåªç”¨äºæ˜¾ç¤ºï¼Œä¸å½±å“ç»Ÿè®¡ï¼‰
            for (let i = 0; i < input.length; i++) {
                if (i < targetSentence.length) {
                    if (input[i] === targetSentence[i]) {
                        sentenceChars[i].classList.add('completed');
                    } else {
                        sentenceChars[i].classList.add('error');
                    }
                }
            }
        
            // æ ‡è®°å½“å‰ä½ç½®
            if (input.length < targetSentence.length) {
                sentenceChars[input.length].classList.add('current');
            }
            
            // æ³¨æ„ï¼šè¿™é‡Œä¸æ›´æ–°ç»Ÿè®¡ï¼Œç»Ÿè®¡åªåœ¨æäº¤æ—¶æ›´æ–°
        });

        // å¥å­è¾“å…¥Enteré”®å¤„ç†
        sentenceInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitCurrentSentence();
            }
        });

        // æäº¤å½“å‰å¥å­
        function submitCurrentSentence() {
            const input = sentenceInput.value;
            const targetSentence = practiceSentences[currentSentenceIndex];
            
            // ç»Ÿè®¡æ­£ç¡®å’Œé”™è¯¯çš„å­—ç¬¦
            let correctCount = 0;
            let errorCount = 0;
            
            // æ¯”è¾ƒè¾“å…¥å’Œç›®æ ‡å¥å­
            const maxLength = Math.max(input.length, targetSentence.length);
            for (let i = 0; i < maxLength; i++) {
                if (i < input.length && i < targetSentence.length) {
                    // ä¸¤è€…éƒ½æœ‰å­—ç¬¦çš„æƒ…å†µ
                    if (input[i] === targetSentence[i]) {
                        correctCount++;
                    } else {
                        errorCount++;
                    }
                } else {
                    // é•¿åº¦ä¸åŒ¹é…çš„éƒ¨åˆ†éƒ½ç®—é”™è¯¯
                    errorCount++;
                }
            }
            
            // æ›´æ–°å…¨å±€ç»Ÿè®¡
            correctChars += correctCount;
            totalChars += maxLength;
            
            // åˆ¤æ–­æ˜¯å¦å®Œå…¨æ­£ç¡®
            const isCorrect = input === targetSentence;
            
            if (isCorrect) {
                message.textContent = 'å¥å­æ­£ç¡®ï¼';
                message.className = 'message success';
            } else {
                message.textContent = 'å¥å­æœ‰è¯¯ï¼ç»§ç»­ä¸‹ä¸€ä¸ª...';
                message.className = 'message warning';
                skippedCount++;
            }
            
            completedItems++;
            
            // æ›´æ–°ç»Ÿè®¡
            updateStats();
            
            setTimeout(() => {
                nextSentence();
            }, 500);
        }

        // ä¸‹ä¸€ä¸ªæ‹¼éŸ³è¯ç»„
        function nextPinyinWord() {
            currentWordIndex++;
            document.querySelector('[data-key="enter"]').classList.remove('highlight');
            
            if (currentWordIndex >= practiceWords.length) {
                // è¿›å…¥å¥å­ç»ƒä¹ é˜¶æ®µ
                startSentencePractice();
            } else {
                currentCharIndex = 0;
                initPinyinDisplay();
                message.textContent = 'ç»§ç»­è¾“å…¥...';
                message.className = 'message';
                updateProgress();
            }
        }

        // å¼€å§‹å¥å­ç»ƒä¹ 
        function startSentencePractice() {
            currentPhase = 'sentence';
            phaseIndicator.textContent = 'ç¬¬äºŒé˜¶æ®µï¼šå¥å­ç»ƒä¹ ';
            phaseIndicator.className = 'phase-indicator active';
            
            // æ¸…é™¤é”®ç›˜æç¤º
            if (currentNextKey) {
                const prevKey = document.querySelector(`[data-key="${currentNextKey}"]`);
                if (prevKey) {
                    prevKey.classList.remove('next-key');
                }
                currentNextKey = null;
            }
            
            pinyinPractice.classList.add('hidden');
            sentencePractice.classList.remove('hidden');
            keyboardWrapper.classList.add('hidden');
            
            completedItems = 0;
            currentSentenceIndex = 0;
            initSentenceDisplay();
            
            message.textContent = 'è¯·è¾“å…¥å¥å­ï¼Œéšæ—¶æŒ‰ Enter é”®æäº¤';
            message.className = 'message';
            
            updateProgress();
        }

        // ä¸‹ä¸€ä¸ªå¥å­
        function nextSentence() {
            currentSentenceIndex++;
            
            if (currentSentenceIndex >= practiceSentences.length) {
                // ç»ƒä¹ å®Œæˆ
                endPractice();
            } else {
                initSentenceDisplay();
                message.textContent = 'ç»§ç»­è¾“å…¥ä¸‹ä¸€ä¸ªå¥å­...';
                message.className = 'message';
                updateProgress();
            }
        }

        // å¼€å§‹ç»ƒä¹ 
        function startPractice() {
            if (practiceWords.length === 0) {
                message.textContent = 'è¯·å…ˆé€‰æ‹©æˆ–åŠ è½½ç»ƒä¹ èµ„æºï¼';
                message.className = 'message error';
                return;
            }

            isActive = true;
            startTime = Date.now();
            phaseStartTime = Date.now();
            startBtn.disabled = true;
            currentPhase = 'pinyin';
            
            message.textContent = 'è¯·åˆ‡æ¢åˆ°è‹±æ–‡è¾“å…¥æ³•ï¼Œéšæ—¶æŒ‰ Enter é”®æäº¤';
            message.className = 'message';
            
            initPinyinDisplay();
            updateProgress();
        }

        // ç»“æŸç»ƒä¹ 
        function endPractice() {
            isActive = false;
            const totalSeconds = Math.round((Date.now() - startTime) / 1000);
            // é€Ÿåº¦åªè®¡ç®—æ­£ç¡®çš„å­—ç¬¦
            const avgSpeed = Math.round(correctChars / (totalSeconds / 60));
            const finalAcc = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;
            
            // è®¡ç®—è¯„çº§
            let grade = 'C';
            if (finalAcc >= 95 && avgSpeed >= 60) grade = 'S';
            else if (finalAcc >= 90 && avgSpeed >= 40) grade = 'A';
            else if (finalAcc >= 80 && avgSpeed >= 25) grade = 'B';
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('finalTime').textContent = `${totalSeconds}ç§’`;
            document.getElementById('finalSpeed').textContent = `${avgSpeed} å­—/åˆ†é’Ÿ`;
            document.getElementById('finalAccuracy').textContent = `${finalAcc}%`;
            document.getElementById('finalErrors').textContent = totalChars - correctChars; // é”™è¯¯æ•° = æ€»æ•° - æ­£ç¡®æ•°
            document.getElementById('finalSkipped').textContent = skippedCount;
            
            const gradeElement = document.getElementById('grade');
            gradeElement.textContent = grade;
            gradeElement.className = `grade ${grade}`;
            
            completeModal.classList.add('show');
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            completeModal.classList.remove('show');
            resetPractice();
        }

        // é‡ç½®ç»ƒä¹ 
        function resetPractice() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            currentPhase = 'pinyin';
            currentWordIndex = 0;
            currentSentenceIndex = 0;
            currentCharIndex = 0;
            correctChars = 0;
            totalChars = 0;
            errorCount = 0;
            completedItems = 0;
            skippedCount = 0;
            isActive = false;
            startTime = null;
            
            // æ¸…é™¤é”®ç›˜æç¤º
            if (currentNextKey) {
                const prevKey = document.querySelector(`[data-key="${currentNextKey}"]`);
                if (prevKey) {
                    prevKey.classList.remove('next-key');
                }
                currentNextKey = null;
            }
            
            // é‡ç½®UI
            startBtn.disabled = false;
            phaseIndicator.textContent = 'ç¬¬ä¸€é˜¶æ®µï¼šæ‹¼éŸ³ç»ƒä¹ ';
            phaseIndicator.className = 'phase-indicator';
            
            pinyinPractice.classList.remove('hidden');
            sentencePractice.classList.add('hidden');
            keyboardWrapper.classList.remove('hidden');
            
            message.textContent = 'ç‚¹å‡»"å¼€å§‹ç»ƒä¹ "ï¼Œéšæ—¶æŒ‰ Enter é”®æäº¤';
            message.className = 'message';
            
            sentenceInput.value = '';
            document.querySelector('[data-key="enter"]').classList.remove('highlight');
            
            if (practiceWords.length > 0) {
                initPinyinDisplay();
            }
            updateStats();
            updateProgress();
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            if (startTime && isActive) {
                const elapsedMinutes = (Date.now() - startTime) / 60000;
                const chars = currentPhase === 'pinyin' ? correctChars : correctChars + sentenceInput.value.length;
                const speed = Math.round(chars / elapsedMinutes);
                speedStat.textContent = speed;
            }

            const accuracy = totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;
            accuracyStat.textContent = accuracy + '%';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            let total, current;
            if (currentPhase === 'pinyin') {
                total = practiceWords.length;
                current = completedItems;
                progressStat.textContent = `${current}/${total}`;
            } else {
                total = practiceSentences.length;
                current = completedItems;
                progressStat.textContent = `${current}/${total}`;
            }
            
            const progress = (current / total) * 100;
            progressBar.style.width = progress + '%';
        }

        // åˆå§‹åŒ–
        loadResourceFile();
    </script>
</body>
</html>